<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>View API Demo</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/theme/dracula.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/javascript/javascript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/edit/matchbrackets.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-beautify/1.14.7/beautify.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-beautify/1.14.7/beautify-javascript.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: Arial, sans-serif;
            background-color: #f0f0f0;
            padding: 1rem;
        }
        .container {
            max-width: 100%;
            margin: 0 auto;
        }
        header {
            text-align: center;
            margin-bottom: 1rem;
        }
        h1 {
            color: #3366cc;
            margin-bottom: 0.5rem;
        }
        .main-content {
            display: flex;
            gap: 1rem;
            height: calc(100vh - 120px);
        }
        .snippets-panel {
            width: 20%;
            background: white;
            border-radius: 4px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        .editor-panel {
            width: 40%;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        .result-panel {
            width: 40%;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        .panel-header {
            padding: 0.7rem;
            background: #333;
            color: white;
            font-weight: bold;
            font-size: 0.9rem;
        }
        .snippets-list {
            overflow-y: auto;
            flex-grow: 1;
        }
        .snippet-item {
            padding: 0.7rem;
            border-bottom: 1px solid #eee;
            cursor: pointer;
        }
        .snippet-item:hover {
            background-color: #f5f5f5;
        }
        .snippet-title {
            font-weight: bold;
            font-size: 0.9rem;
            margin-bottom: 0.2rem;
        }
        .snippet-desc {
            font-size: 0.8rem;
            color: #666;
        }
        .editor-toolbar {
            display: flex;
            gap: 0.5rem;
            padding: 0.5rem;
            background: #333;
            border-radius: 4px 4px 0 0;
        }
        button {
            padding: 0.3rem 0.7rem;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 0.8rem;
            color: white;
        }
        .run-btn {
            background: #4CAF50;
            margin-left: auto;
        }
        .clear-btn {
            background: #ff9800;
        }
        .wrap-btn {
            background: #ff9800;
        }
        .format-btn {
            background: #ff9800;
        }
        .CodeMirror {
            flex-grow: 1;
            border-radius: 0 0 4px 4px;
            font-size: 0.9rem !important;
            height: auto !important;
        }
        .result-content {
            flex-grow: 1;
            padding: 0.7rem;
            background: white;
            border-radius: 0 0 4px 4px;
            font-family: Consolas, Monaco, monospace;
            font-size: 0.9rem;
            overflow: auto;
            border: 1px solid #ddd;
        }
        .instructions {
            margin-top: 1rem;
            padding: 1rem;
            background: white;
            border-radius: 4px;
            font-size: 0.9rem;
            color: #666;
        }
        .instructions h3 {
            margin-bottom: 0.5rem;
            color: #333;
        }
        .instructions ul {
            margin-left: 1.5rem;
        }
        .instructions li {
            margin-bottom: 0.3rem;
        }
        .success {
            color: #28a745;
        }
        .error {
            color: #dc3545;
        }
        .info {
            color: #17a2b8;
        }
        .pending {
            color: #ffc107;
        }
        .execution-status {
            font-style: italic;
            color: #666;
            margin-top: 0.5rem;
            padding-top: 0.5rem;
            border-top: 1px dashed #eee;
        }
        .fetch-request {
            margin: 0.5rem 0;
            padding: 0.5rem;
            border-left: 3px solid #17a2b8;
            background-color: #e3f2fd;
        }
        .fetch-response {
            margin: 0.5rem 0;
            padding: 0.5rem;
            border-left: 3px solid #28a745;
            background-color: #e8f5e9;
        }
        .fetch-error {
            margin: 0.5rem 0;
            padding: 0.5rem;
            border-left: 3px solid #dc3545;
            background-color: #ffebee;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>View API Demo</h1>
        </header>
        
        <div class="main-content">
            <div class="snippets-panel">
                <div class="panel-header">代码片段库</div>
                <div class="snippets-list" id="snippetsList">
                    <div class="snippet-item" data-index="0">
                        <div class="snippet-title">基础视图查询</div>
                        <div class="snippet-desc">最简单的视图查询用法</div>
                    </div>
                    <div class="snippet-item" data-index="1">
                        <div class="snippet-title">表查询</div>
                        <div class="snippet-desc">直接查询数据库中的表数据</div>
                    </div>
                    <div class="snippet-item" data-index="2">
                        <div class="snippet-title">filter的使用</div>
                        <div class="snippet-desc">视图、表查询使用filter对数据进行过滤</div>
                    </div>
                    <div class="snippet-item" data-index="3">
                        <div class="snippet-title">读取表数据</div>
                        <div class="snippet-desc">扫描表结构中的key字段，传入key值，读取表数据</div>
                    </div>
                    <div class="snippet-item" data-index="4">
                        <div class="snippet-title">单条数据的CRUD</div>
                        <div class="snippet-desc">单条数据进行增加修改删除操作，读取自增字段</div>
                    </div>
                    <div class="snippet-item" data-index="5">
                        <div class="snippet-title">批量数据的编辑</div>
                        <div class="snippet-desc">提交数组，用key判断是否存在，插入或更改</div>
                    </div>
                </div>
            </div>
            <div class="editor-panel">
                <div class="panel-header">代码编辑区</div>
                <div class="editor-toolbar">
                    <button class="wrap-btn" id="wrapBtn">换行</button>
                    <button class="clear-btn" id="clearBtn">清空</button>
                    <button class="format-btn" id="formatBtn">格式化</button>
                    <button class="run-btn" id="runBtn">运行</button>
                </div>
                <textarea id="codeInput">// 示例代码
console.log("Hello, JavaScript!");</textarea>
            </div>
            <div class="result-panel">
                <div class="panel-header">执行结果</div>
                <div class="result-content" id="resultOutput">
                    点击"运行"按钮执行代码...
                </div>
            </div>
        </div>
    </div>

    <script>
        const editor = CodeMirror.fromTextArea(document.getElementById('codeInput'), {
            mode: "javascript",        
            theme: "dracula",          
            lineNumbers: true,       
            matchBrackets: true,     
            autoCloseBrackets: true, 
            indentUnit: 4,           
            indentWithTabs: false,   
            lineWrapping: true       
        });
        const codeSnippets = [
            `// 基础视图查询
async function fetchData() {
    try {
        console.log('# 查询视图，视图定义内容存放于“\\\\src\\\\main\\\\resources\\\\view\\\\demo\\\\query.sql”');
        console.log('  视图代码: demo.query,映射url路径/demo/query');
        console.log('  传入参数实现分页，排序，搜索，统计等功能');
        const url = '/demo/view/demo/query?domainKey=domain1&page=1&size=5&sort=domainKey-d,depKey-d&aggrs=';
        console.log(\`  url: \${url}\`);
        const res = await fetch(url);
        const data = await res.json();
        console.log("# result:");
        console.log(JSON.stringify(data, null, 2));
    } catch (error) {
        console.error("error:", error.message);
    }
}
// 执行请求
fetchData();`,
            `// 表查询
async function fetchData() {
    try {
        console.log('# 直接查询数据表');
        console.log('  表名: view_demo.department,映射url路径/view_demo/department');
        console.log('  传入参数实现分页，排序，搜索，统计等功能');
        const url = '/demo/view/view_demo/department?type=table&page=1&size=5&sort=domainKey-d,depKey-d&aggrs=';
        console.log(\`  url: \${url}\`);
        const res = await fetch(url);
        const data = await res.json();
        console.log("# result:");
        console.log(JSON.stringify(data, null, 2));
    } catch (error) {
        console.error("error:", error.message);
    }
}
// 执行请求
fetchData();`,

            `// filter的使用
async function fetchData() {
    // 声明一个filter
    const filter = {
        "criteria": [{
                //EQUAL,CONTAINS,
                //STARTS_WITH,ENDS_WITH,
                //LESS_THAN,LESS_THAN_OR_EQUAL,
                //LARGER_THAN,LARGER_THAN_OR_EQUAL,
                //IS_EMPTY
                "op": "CONTAINS",
                "field": "createUser",
                "value": "adm"
            },
            {
                "op": "LARGER_THAN",
                "field": "createTime",
                "value": "2025-07-25 22:05:45",
            },
            {
                //or,and
                "type": "or",
                //criteria可以递归套嵌查询条件，相当于SQL在括号中加查询条件
                "criteria": [{
                        "op": "LARGER_THAN",
                        "field": "createTime",
                        "value": "2025-07-25 22:05:45",
                    },
                    {
                        "op": "LARGER_THAN",
                        "field": "createTime",
                        "value": "2025-07-25 22:05:45",
                    },
                ]
            }
        ],
        //or,and
        "type": "and"
    };
    //定义url中的参数
    const params = {
        page: 1,
        size: 3,
        sort: "depKey-d",
        type: "table",
        filter: JSON.stringify(filter),
        //有这个字段，多会跑一次汇总sql，
        //默认统计总记录数可以传入统计命令返回更多汇总信息
        //例如：number_field-count,number_field-sum,number_field-avg
        aggrs: "_"
    };
    const searchParams = new URLSearchParams();
    for (const [key, value] of Object.entries(params)) {
        searchParams.append(key, value);
    };
    try {
        console.log("# 使用filter对数据进行过滤 ");
        const url = \`/demo/view/view_demo/department?\${searchParams.toString()}\`;
        console.log(\`  url: \${url}\`);
        const res = await fetch(url);
        const data = await res.json();
        console.log("# result:");
        console.log(JSON.stringify(data, null, 2));
    } catch (error) {
        console.error("error:", error.message);
    }
}
// 执行请求
fetchData();`,

            `// 读取表数据
async function fetchData() {
    try {
        console.log('# 根据key字段读取数据表及其表结构');
        const url = '/demo/table/view_demo/department?domainKey=domain1&depKey=dep02';
        console.log(\`  url: \${url}\`);
        const res = await fetch(url);
        const data = await res.json();
        console.log("# result:");
        console.log(JSON.stringify(data, null, 2));
    } catch (error) {
        console.error("error:", error.message);
    }
}
// 执行请求
fetchData();`,
            
            `// 单条数据的CRUD
async function runDataEdit() {
    const insertResp = await commonReq('/demo/table/view_demo/test_field', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            deptId: 111,
            userId: 111,
            createTime: "2025-07-30 12:12:12"
        })
    }, '插入一条记录', '返回记录内容，包括自增ID');
    await commonReq('/demo/table/view_demo/test_field?id=' + insertResp.id, {
        method: 'GET',
        headers: {
            'Content-Type': 'application/json',
        },
    }, '根据Key读取一条记录', '返回记录内容');
    await commonReq('/demo/table/view_demo/test_field', {
        method: 'PATCH',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            id: insertResp.id,
            deptId: 5555,
            userId: 5555,
            createTime: "2025-07-30 12:12:12"
        })
    }, '根据Key更新一条记录', '返回影响记录的数目');
    await commonReq('/demo/table/view_demo/test_field?id=' + insertResp.id, {
        method: 'GET',
        headers: {
            'Content-Type': 'application/json',
        },
    }, '根据Key读取一条记录', '返回记录内容');
    await commonReq('/demo/table/view_demo/test_field', {
        method: 'DELETE',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            id: insertResp.id
        })
    }, '根据Key删除一条记录', '返回影响记录的数目');
}
async function commonReq(url, fetchOptions, reqDesc, respDesc) {
    try {
        console.log('# ' + reqDesc);
        console.log('# URL:' + url);
        console.log(JSON.stringify(fetchOptions, null, 2));
        const res = await fetch(url, fetchOptions);
        const data = await res.json();
        console.log('# ' + respDesc + ':');
        console.log(JSON.stringify(data, null, 2));
        console.log('----------------------');
        return data;
    } catch (error) {
        console.error("error:", error.message);
    }
    return null;
}
// 执行
runDataEdit();`,
            
            `// 批量数据的编辑
async function runBatchDataEdit() {
    await commonReq('/demo/table/view_demo/position', {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify([{
                "domainKey": "domainKey1111",
                "depKey": "depKey1111",
                "posKey": "posKey1111",
                "posName": "posName1111",
                "createTime": "2025-07-30 12:12:12",
                "updateTime": "2025-07-30 12:12:12",
                "createUser": "Ryan",
                "updateUser": "Ryan"
            },
            {
                "domainKey": "domainKey1111",
                "depKey": "depKey1111",
                "posKey": "posKey2222",
                "posName": "posName2222",
                "createTime": "2025-07-30 12:12:12",
                "updateTime": "2025-07-30 12:12:12",
                "createUser": "Ryan",
                "updateUser": "Ryan"
            }
        ])
    }, '根据Key对数据进行跟新，有数据修改，没有数据插入', '返回影响记录的数目');
    await commonReq('/demo/table/view_demo/position?domainKey=domainKey1111&depKey=depKey1111&posKey=posKey2222', {
        method: 'GET',
        headers: {
            'Content-Type': 'application/json',
        },
    }, '根据Key读取一条记录', '返回记录内容');
    await commonReq('/demo/table/view_demo/position', {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify([{
                "domainKey": "domainKey1111",
                "depKey": "depKey1111",
                "posKey": "posKey1111",
                "posName": "posName1111已变更",
                "createTime": "2025-07-30 12:12:12",
                "updateTime": "2025-07-30 12:12:12",
                "createUser": "Ryan",
                "updateUser": "Ryan"
            },
            {
                "domainKey": "domainKey1111",
                "depKey": "depKey1111",
                "posKey": "posKey2222",
                "posName": "posName2222已变更",
                "createTime": "2025-07-30 12:12:12",
                "updateTime": "2025-07-30 12:12:12",
                "createUser": "Ryan",
                "updateUser": "Ryan"
            }
        ])
    }, '根据Key对数据进行跟新，有数据修改，没有数据插入', '返回影响记录的数目');
    await commonReq('/demo/table/view_demo/position?domainKey=domainKey1111&depKey=depKey1111&posKey=posKey2222', {
        method: 'GET',
        headers: {
            'Content-Type': 'application/json',
        },
    }, '根据Key读取一条记录', '返回记录内容');
    await commonReq('/demo/table/view_demo/position', {
        method: 'PATCH',
        headers: {
            'Content-Type': 'application/json',
            'whereFields': 'domainKey,depKey',
            'assertMaxRecordAffected': 3
        },
        body: JSON.stringify({
            "domainKey": "domainKey1111",
            "depKey": "depKey1111",
            "posName": "更新字段内容"
        })
    }, '根据字段domainKey,depKey跟新数据，断然最大影响记录数为3', '返回影响记录的数目');
    await commonReq('/demo/table/view_demo/position?domainKey=domainKey1111&depKey=depKey1111&posKey=posKey2222', {
        method: 'GET',
        headers: {
            'Content-Type': 'application/json',
        },
    }, '根据Key读取一条记录', '返回记录内容');
    await commonReq('/demo/table/view_demo/position', {
        method: 'DELETE',
        headers: {
            'Content-Type': 'application/json',
            'whereFields': 'domainKey,depKey',
            'assertMaxRecordAffected': 3
        },
        body: JSON.stringify({
            "domainKey": "domainKey1111",
            "depKey": "depKey1111"
        })
    }, '根据字段domainKey,depKey删除数据，断然最大删除记录数为3', '返回影响记录的数目');
}
async function commonReq(url, fetchOptions, reqDesc, respDesc) {
    try {
        console.log('# ' + reqDesc);
        console.log('# URL:' + url);
        console.log(JSON.stringify(fetchOptions, null, 2));
        const res = await fetch(url, fetchOptions);
        const data = await res.json();
        console.log('# ' + respDesc + ':');
        if (fetchOptions.method == 'GET') {
            console.log(JSON.stringify(data.data, null, 2));
        } else {
            console.log(JSON.stringify(data, null, 2));
        }
        console.log('----------------------');
        return data;
    } catch (error) {
        console.error("error:", error.message);
    }
    return null;
}
// 执行
runBatchDataEdit();`,
            
            `// Fetch API示例（增强版）
async function fetchData() {
    try {
        // 简单GET请求
        console.log("发送简单GET请求...");
        const response1 = await fetch('https://httpbin.org/get?param1=test&param2=123');
        const data1 = await response1.json();
        console.log("GET请求结果:",JSON.stringify(data1, null, 2));
        
        // POST请求
        console.log("发送POST请求...");
        const response2 = await fetch('https://httpbin.org/post', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                name: '测试用户',
                age: 25,
                hobbies: ['阅读', '编程']
            })
        });
        const data2 = await response2.json();
        console.log("POST请求结果:",JSON.stringify(data2, null, 2));
        
    } catch (error) {
        console.error("请求失败:", error.message);
    }
}

// 执行请求
fetchData();`
        ];
        const resultOutput = document.getElementById('resultOutput');
        const runBtn = document.getElementById('runBtn');
        const clearBtn = document.getElementById('clearBtn');
        const wrapBtn = document.getElementById('wrapBtn');
        const formatBtn = document.getElementById('formatBtn'); 
        let isWrapping = true;
        let pendingPromises = 0;

        document.querySelectorAll('.snippet-item').forEach(item => {
            item.addEventListener('click', () => {
                const index = item.getAttribute('data-index');
                editor.setValue(codeSnippets[index]);
                document.querySelectorAll('.snippet-item').forEach(i => {
                    i.style.backgroundColor = '';
                });
                item.style.backgroundColor = '#e6f7ff';
                editor.focus();
            });
        });

        clearBtn.addEventListener('click', () => {
            editor.setValue('');
            document.querySelectorAll('.snippet-item').forEach(i => {
                i.style.backgroundColor = '';
            });
            editor.focus();
        });

        wrapBtn.addEventListener('click', () => {
            isWrapping = !isWrapping;
            editor.setOption('lineWrapping', isWrapping);
            wrapBtn.textContent = isWrapping ? '换行' : '不换行';
        });

        formatBtn.addEventListener('click', () => {
            try {
                const unformattedCode = editor.getValue();
                const options = {
                    indent_size: 4,        
                    indent_char: ' ',      
                    eol: '\n',             
                    preserve_newlines: true,
                    max_preserve_newlines: 2
                };
                const formattedCode = js_beautify(unformattedCode, options);
                editor.setValue(formattedCode);
                editor.focus();

                const infoLine = document.createElement('div');
                infoLine.className = 'info';
                infoLine.textContent = '代码格式化成功';
                resultOutput.appendChild(infoLine);
                resultOutput.scrollTop = resultOutput.scrollHeight;
            } catch (error) {
                const errorLine = document.createElement('div');
                errorLine.className = 'error';
                errorLine.textContent = `格式化错误: ${error.message}`;
                resultOutput.appendChild(errorLine);
                resultOutput.scrollTop = resultOutput.scrollHeight;
            }
        });

        runBtn.addEventListener('click', runCode);
        
        editor.addKeyMap({
            "Ctrl-Enter": runCode
        });

        editor.addKeyMap({
            "Ctrl-Shift-F": function() {
                formatBtn.click();
            }
        });

        async function runCode() {
            resultOutput.innerHTML = '';
            pendingPromises = 0;
            
            const originalLog = console.log;
            const originalError = console.error;
            const originalPromise = window.Promise;
            const originalFetch = window.fetch; 
            
            try {
                console.log = function(...args) {
                    const line = document.createElement('pre');
                    line.textContent = args.join(' ');
                    resultOutput.appendChild(line);
                    resultOutput.scrollTop = resultOutput.scrollHeight;
                };
                
                console.error = function(...args) {
                    const line = document.createElement('pre');
                    line.className = 'error';
                    line.textContent = args.join(' ');
                    resultOutput.appendChild(line);
                    resultOutput.scrollTop = resultOutput.scrollHeight;
                };
                
                window.Promise = function(executor) {
                    pendingPromises++;
                    updateExecutionStatus();
                    const promise = new originalPromise((resolve, reject) => {
                        executor(
                            (value) => {
                                resolve(value);
                                pendingPromises--;
                                updateExecutionStatus();
                            },
                            (reason) => {
                                reject(reason);
                                pendingPromises--;
                                updateExecutionStatus();
                            }
                        );
                    });
                    
                    return promise;
                };
                
                window.Promise.all = originalPromise.all;
                window.Promise.race = originalPromise.race;
                window.Promise.resolve = originalPromise.resolve;
                window.Promise.reject = originalPromise.reject;

                window.fetch = async function(url, options = {}) {
                    pendingPromises++;
                    updateExecutionStatus();
                    try {
                        const response = await originalFetch(url, options);
                        return response;
                    } catch (error) {
                        const errorInfo = document.createElement('div');
                        errorInfo.className = 'fetch-error';
                        errorInfo.innerHTML = `<strong>Fetch错误:</strong> ${error.message}`;
                        resultOutput.appendChild(errorInfo);
                        resultOutput.scrollTop = resultOutput.scrollHeight;
                        throw error;
                    } finally {
                        pendingPromises--;
                        updateExecutionStatus();
                    }
                };

                const code = editor.getValue();
                
                const wrappedCode = `(async () => {
                    ${code}
                })()`;
                
                await eval(wrappedCode);
                
                while (pendingPromises > 0) {
                    await new Promise(resolve => setTimeout(resolve, 100));
                }

            } catch (error) {
                const errorLine = document.createElement('div');
                errorLine.className = 'error';
                errorLine.textContent = `错误: ${error.message}`;
                resultOutput.appendChild(errorLine);
            } finally {
                console.log = originalLog;
                console.error = originalError;
                window.Promise = originalPromise;
                window.fetch = originalFetch;
                
                updateExecutionStatus(true);
            }
        }
        
        function updateExecutionStatus(isFinal = false) {
            const oldStatus = document.querySelector('.execution-status');
            if (oldStatus) {
                oldStatus.remove();
            }
            
            const statusElement = document.createElement('div');
            statusElement.className = 'execution-status';
            
            if (isFinal) {
                statusElement.textContent = '执行完成';
            } else if (pendingPromises > 0) {
                statusElement.textContent = `等待异步操作完成 (${pendingPromises} 个操作)`;
                statusElement.classList.add('pending');
            } else {
                statusElement.textContent = '执行完成';
            }
            
            resultOutput.appendChild(statusElement);
            resultOutput.scrollTop = resultOutput.scrollHeight;
        }

        editor.setSize(null, '100%');
    </script>
</body>
</html>